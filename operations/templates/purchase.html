{% extends "layout.html" %}
{% block content %}
<h1 class='text-3xl mb-4'>Purchase New Items</h1>
<div class='container'>
    <strong>Invoice No.:</strong>
    <label class='mb-4'>{{ invoice_number }}</label><br>

    <form id="item-form" method="post" class='space-x-4'>
        {% csrf_token %}
        <label>Item:</label>
        {{ temp_form.item_id }}
        <span id="item-price"></span>  <!-- Display item price -->
        <label>Quantity:</label>
        {{ temp_form.quantity }}
        <span id="item-total"></span>  <!-- Display item total -->

        <button class='btn btn-primary' type="submit" name="add_item">Add Item</button>
        {{ temp_form.item_id.errors }}
    </form>

    <form id="supplier-form" method="post" class='space-x-4 mt-4'>
        {% csrf_token %}
        <label>Supplier:</label>
        {{ purchase_form.supplier_id }}
        <div id="supplier-details"></div> <!-- Supplier details display -->
        
        <button class='btn btn-primary mt-2' id="finalizePurchaseBtn" type="submit" name="finalize_purchase">Finalize Purchase</button>
    </form>

    <!-- Display added items -->
    <table class="table mt-4">
        <thead>
            <tr>
                <th scope="col">Sl. No.</th>
                <th scope="col">Item</th>
                <th scope="col">Quantity</th>
                <th scope="col">Total</th>
            </tr>
        </thead>
        <tbody>
            {% for item in temp_items %}
            <tr>
                <td scope="row">{{ forloop.counter }}</td>
                <td>{{ item.item_id.name }}</td>
                <td>{{ item.quantity }}</td>
                <td>{{ item.items_total }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <div>
        <strong>Subtotal: </strong> {{ sub_total }}
    </div>
</div>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script>
    $(document).ready(function() {
        // Update item price when an item is selected
        $('#id_item_id').change(function() {
            let itemId = $(this).val();
            if (itemId) {
                $.ajax({
                    url: '/get-item-price/' + itemId + '/',
                    success: function(data) {
                        $('#item-price').text('Price: ' + data.price);
                        updateItemTotal();
                    }
                });
            } else {
                $('#item-price').text('');
                $('#item-total').text('');
            }
        });

        // Update item total when quantity changes
        $('#id_quantity').on('input', function() {
            updateItemTotal();
        });

        function updateItemTotal() {
            let quantity = $('#id_quantity').val();
            let priceText = $('#item-price').text();
            let price = parseFloat(priceText.replace('Price: ', ''));
            if (quantity && price) {
                let total = price * quantity;
                $('#item-total').text('Total: ' + total.toFixed(2));
            } else {
                $('#item-total').text('');
            }
        }

        // Fetch supplier details when a supplier is selected
    });
</script>

<script>
    // Store and retrieve selected supplier using local storage
    document.addEventListener("DOMContentLoaded", function () {
        const supplierSelect = document.getElementById('id_supplier_id');
        const finalizePurchaseBtn = document.getElementById('finalizePurchaseBtn');
    
        // Set the supplier on page load if available in localStorage
        const storedSupplier = localStorage.getItem('selectedSupplier');
        if (storedSupplier) {
            supplierSelect.value = storedSupplier;
        }
    
        // Store selected supplier in local storage when changed
        supplierSelect.addEventListener('change', function () {
            localStorage.setItem('selectedSupplier', this.value);
        });
    
        // Clear localStorage when 'Finalize Purchase' button is clicked
        finalizePurchaseBtn.addEventListener('click', function () {
            localStorage.removeItem('selectedSupplier'); // Or use localStorage.clear() to remove everything
        });
    });
</script>

{% endblock %}
